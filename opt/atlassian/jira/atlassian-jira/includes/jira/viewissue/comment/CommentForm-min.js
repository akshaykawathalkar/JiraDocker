define("jira/viewissue/comment/comment-form",["jira/util/formatter","jira/util/events","jira/util/events/types","jira/ajs/ajax/smart-ajax","jira/issue","jira/dialog/form-dialog","wrm/context-path","jira/jquery/deferred","jquery"],function(formatter,Events,Types,SmartAjax,IssueApi,FormDialog,wrmContextPath,Deferred,$){var contextPath=wrmContextPath();var commentForm={setCaretAtEndOfCommentField:function(){var $field=this.getField();var field=$field[0];var length;if($field.length){length=$field.val().length;$field.scrollTop($field.attr("scrollHeight"));if(field.setSelectionRange&&length>0){field.setSelectionRange(length,length)}}},disable:function(){this.getForm().find("textarea").attr("readonly","readonly");this.getForm().find("input[type=submit]").attr("disabled","disabled")},isDirty:function(){var field=this.getField();if(field.length){return field[0].value!==field[0].defaultValue}return false},handleBrowseAway:function(){if(!commentForm.isDirty()){return }var form=commentForm.getForm();var isVisible=form.length&&form.is(":visible");if(isVisible){return formatter.I18n.getText("common.forms.dirty.comment")}},isVisibilityAvailble:function(){return this.getForm().find("#commentLevel :selected").val()!="none"},setSubmitState:function(){if($.trim(this.getField().val()).length>0&&this.isVisibilityAvailble()){this.getForm().find("#issue-comment-add-submit").removeAttr("disabled")}else{this.getForm().find("#issue-comment-add-submit").attr("disabled","disabled")}},enable:function(){this.getForm().find("textarea").removeAttr("readonly");this.getForm().find("input[type=submit]").removeAttr("disabled")},getCommentVisibility:function(){var visibility=this.getForm().find("#commentLevel :selected").val();if(visibility){var split_v=visibility.split(":");return{"type":split_v[0],"value":this.getForm().find("#commentLevel :selected").text()}}return null},ajaxSubmit:function(){var $loading=$('<span class="icon throbber loading"></span>');var issueId=IssueApi.getIssueId();var issueKey=IssueApi.getIssueKey();var restURL=contextPath+"/rest/api/2/issue/"+issueKey+"/comment";var newComment={"body":this.getField()[0].value.replace(/\r?\n/g,"\r\n")};var visibility=this.getCommentVisibility();if(visibility){newComment["visibility"]=visibility}var updateDone=Deferred();var result=$.ajax({url:restURL,type:"POST",contentType:"application/json",data:JSON.stringify(newComment),success:function(data){Events.trigger(Types.UNLOCK_PANEL_REFRESHING,["addcommentmodule"]);Events.trigger(Types.REFRESH_ISSUE_PAGE,[issueId,{complete:function(){var newCommentId="comment-"+data.id;$("#"+newCommentId).scrollIntoView({marginBottom:200,marginTop:200});var $focusedTabs=$("#issue_actions_container > .issue-data-block.focused");$focusedTabs.removeClass("focused");var $newfocusedTab=$("#"+newCommentId);$newfocusedTab.addClass("focused");$loading.remove();commentForm.enable();updateDone.resolve()}}])},error:function(xhr){function buildErrorDialog(errorMessage){var errorContent="<h2>"+formatter.I18n.getText("common.words.error")+"</h2>"+'<div class="ajaxerror">'+'<div class="aui-message error">'+'<span class="aui-icon icon-warning"/>'+errorMessage+"</div>"+"</div>";return $(errorContent)}var response=$.parseJSON(xhr.responseText);var content;if(response&&response.errors&&response.errors.comment){content=buildErrorDialog(response.errors.comment)}else{content=SmartAjax.buildDialogErrorContent(xhr)}new FormDialog({content:content}).show();$loading.remove();commentForm.enable();updateDone.reject()}});var $buttonContainer=this.getForm().find("input[type=submit]").parent();if($buttonContainer.is(".wiki-button-bar-content")){$loading.css("margin-right","10px").prependTo($buttonContainer)}else{$loading.appendTo($buttonContainer)}return $.when(result,updateDone)},getForm:function(){var $form=$("form#issue-comment-add");if($form.length===1){this.$form=$form}return this.$form||$()},getField:function(){return this.getForm().find("#comment")},getSubmitButton:function(){return this.getForm().find("#issue-comment-add-submit")},hide:function(cancel){if(cancel){this.cancel()}this.getForm().detach();if(Types.UNLOCK_PANEL_REFRESHING){Events.trigger(Types.UNLOCK_PANEL_REFRESHING,["addcommentmodule"])}},show:function(){this.focus();if(Types.LOCK_PANEL_REFRESHING){Events.trigger(Types.LOCK_PANEL_REFRESHING,["addcommentmodule"])}},focus:function(){this.focusField();this.setCaretAtEndOfCommentField()},focusField:function(){this.getField().focus().trigger("keyup");this.getSubmitButton().scrollIntoView({marginBottom:200})},showNoCommentMsg:function(e){if(this.getField().val()===""){$("#emptyCommentErrMsg").show();return true}},cancel:function(){var instance=this;setTimeout(function(){instance.getField().val("")},100);$("#comment-preview_link.selected").click()}};return commentForm});define("jira/viewissue/comment/footer-comment",["jira/viewissue/comment/comment-form","jquery"],function(commentForm,$){var commentFormIsBeingSubmitted=false;var isInPreviewMode=false;var footerComment={getModule:function(){return $("#addcomment")},isActive:function(){return this.getModule().hasClass("active")},hide:function(cancel){if(this.isActive()){var dirtyMessage=commentForm.handleBrowseAway();if(isInPreviewMode||commentFormIsBeingSubmitted||!dirtyMessage||confirm(dirtyMessage)){this.getModule().removeClass("active");commentForm.hide(cancel)}}},ajaxSubmit:function(){commentFormIsBeingSubmitted=true;commentForm.ajaxSubmit().then(function(){footerComment.hide(true)})},show:function(){if(!this.isActive()){commentFormIsBeingSubmitted=false;this.getModule().addClass("active");this.appendForm();commentForm.show()}else{commentForm.focusField()}},appendForm:function(){this.getModule().find(".mod-content").append(commentForm.getForm())}};footerComment.setPreviewMode=function(isEnabled){isInPreviewMode=Boolean(isEnabled)};return footerComment});