define("jira/dialog/link-issue-dialog-factory",["require"],function(require){var deprecator=require("jira/deprecator");var DialogFactory=require("jira/dialog/dialog-factory");var FormDialog=require("jira/dialog/form-dialog");var DialogUtil=require("jira/dialog/dialog-util");var SmartAjax=require("jira/ajs/ajax/smart-ajax");var Issue=require("jira/issue");var IssueNavigator=require("jira/issuenavigator/issue-navigator");var jQuery=require("jquery");var Deferred=require("jira/jquery/deferred");var wrmContextPath=require("wrm/context-path");var wrmRequire=require("wrm/require");var contextPath=wrmContextPath();function markSelectedLinkType(activeId,linkTypes){var hasSelected=false;jQuery.each(linkTypes,function(i,linkType){if(linkType.id===activeId){linkType.isSelected=true;hasSelected=true;return false}});if(!hasSelected){linkTypes[0].isSelected=true}return linkTypes}function getRemoteIssueLinks(issueId){var deferred=new Deferred();SmartAjax.makeRequest({url:contextPath+"/rest/viewIssue/1/remoteIssueLink/linkType?issueId="+issueId,complete:function(xhr,textStatus,smartAjaxResult){if(smartAjaxResult.successful){deferred.resolve(smartAjaxResult.data)}else{deferred.reject(SmartAjax.buildDialogErrorContent(smartAjaxResult))}}});return deferred.promise()}function getTabContent(dialog){var deferred=new Deferred();var ajaxOptions=DialogUtil.getDefaultAjaxOptions.call(dialog);ajaxOptions.complete=function(xhr,textStatus,smartAjaxResult){if(smartAjaxResult.successful){deferred.resolve(smartAjaxResult.data)}else{deferred.reject(SmartAjax.buildDialogErrorContent(smartAjaxResult))}};SmartAjax.makeRequest(ajaxOptions);return deferred.promise()}function getActiveTabId(dialog){return dialog.$activeTrigger.attr("id")}function loadIssueLinkContentResources(){return wrmRequire(["wrc!com.atlassian.jira.jira-issue-link-web-plugin:init-issuelink-web","wrc!com.atlassian.jira.jira-issue-link-confluence-plugin:init-issuelink-confluence","wrc!com.atlassian.jira.jira-issue-link-remote-jira-plugin:init-issuelink-jira"])}function createLinkIssueDialog(trigger){return new FormDialog({id:"link-issue-dialog",isIssueDialog:true,trigger:trigger,onSuccessfulSubmit:function(data,smartAjaxResponse){if(smartAjaxResponse.getResponseHeader("X-Atlassian-Dialog-Msg-Type")!=="warning"){DialogUtil.storeCurrentIssueIdOnSucessfulSubmit.apply(this,arguments)}},issueMsg:"thanks_issue_linked",widthClass:"large",stacked:true,content:function(ready){var dialog=this;var issueId=Issue.getIssueId()||IssueNavigator.getSelectedIssueId();var loadUIResourcesDeferred=loadIssueLinkContentResources();var remoteIssueLinksDeferred=getRemoteIssueLinks(issueId);var tabContentDeferred=getTabContent(dialog);jQuery.when(tabContentDeferred,remoteIssueLinksDeferred,loadUIResourcesDeferred).done(function(tabContent,linkTypes){linkTypes=markSelectedLinkType(getActiveTabId(dialog),linkTypes);ready(JIRA.Templates.LinkIssue.dialog({linkTypes:linkTypes,tabContent:tabContent}));jQuery.each(linkTypes,function(i,linkType){var focusElementSelector;if(linkType.isSelected===true){focusElementSelector="[name='"+linkType.focusedFieldName+"']";if(jQuery(focusElementSelector).length===0){focusElementSelector="#"+linkType.id}dialog._focusFirstField(focusElementSelector)}})}).fail(function(tabContentError,linkTypeError){ready(linkTypeError||tabContentError)})},formatSubmitResponseContent:function(content){this.get$popupContent().find(".dialog-pane").html(content);return this.get$popupContent().html()},onContentRefresh:function(){this.bindAnchorsToDialog(this.get$popupContent().find(".dialog-menu-item "))}})}DialogFactory.createLinkIssueDialog=createLinkIssueDialog;deprecator.prop(DialogFactory,"createLinkIssueDialog",{sinceVersion:"7.3",removeInVersion:"8.0"});return{createLinkIssueDialog:createLinkIssueDialog}});